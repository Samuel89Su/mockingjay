<template>
  <div id="pn_details">
    <h1>General</h1>
    <div>
      <span id="sp_method">{{ config.method }}</span>
      <span id="sp_path">{{ config.path }}</span><br/>
      <label for="ck_mock">Mock</label>
      <input type="checkbox" id="ck_mock" v-model="config.mock">
    </div>
    <div id="dv_mockCfg">
      <label for="checkbox">Validate Request: </label>
      <input type="checkbox" id="ck_valiReq" v-model="config.mockCfg.validateReq"><br/>
      <h2>Request description</h2>
      <h3>Queries</h3>
      <ul>
        <KeyValidationEditor :key="'mockCfg_reqDescriptor_queries_' + keyDesc.key" v-if="keyDesc !== null" v-for="(keyDesc, index) in config.mockCfg.reqDescriptor.queries" v-model="config.mockCfg.reqDescriptor.queries[index]"></KeyValidationEditor>
      </ul>
      <h3>Headers</h3>
      <ul>
        <KeyValidationEditor :key="'mockCfg_reqDescriptor_headers_' + keyDesc.key" v-if="keyDesc !== null" v-for="(keyDesc, index) in config.mockCfg.reqDescriptor.headers" v-model="config.mockCfg.reqDescriptor.headers[index]"></KeyValidationEditor>
      </ul>
      <h3>Body</h3>
      <div>
        <BodyValidationEditor v-model="config.mockCfg.reqDescriptor.body"></BodyValidationEditor>
      </div>
      <h2>Response description</h2>
      <h3>Headers</h3>
      <ul>
        <KeyReactorEditor :key="'mockCfg_resDescriptor_headers_' + keyDesc.key" v-if="keyDesc !== null" v-for="(keyDesc, index) in config.mockCfg.resDescriptor.headers" v-model="config.mockCfg.resDescriptor.headers[index]"></KeyReactorEditor>
      </ul>
      <h3>Body</h3>
      <div>
        <BodyReactorEditor v-model="config.mockCfg.resDescriptor.body"></BodyReactorEditor>
      </div>
    </div>

    <button id="btn_submit" v-on:click="updateConfig">Update</button>

  </div>
</template>

<script>

const localComponents = {};

import keyValiEditor from './KeyValidationEditor'
localComponents[keyValiEditor.name] = keyValiEditor.opts
import bodyValiEditor from './BodyValidationEditor'
localComponents[bodyValiEditor.name] = bodyValiEditor.opts
import keyReactEditor from './KeyReactorEditor'
localComponents[keyReactEditor.name] = keyReactEditor.opts
import bodyReactEditor from './BodyReactorEditor'
localComponents[bodyReactEditor.name] = bodyReactEditor.opts

const InventoryAPI = require('./InventoryAPI')

import defaultMockCfg from './ApiMockCfgDefault'

const cusHeaders = new Headers();
cusHeaders.append("Content-Type", "application/json");

export default {
  name: "ApiList",
  data() {
    return {
      sketch: null,
      config: {
        method: 'GET',
        path: '',
        mock: false,
        mockCfg: {
          validateReq: false,
          reqDescriptor: {
            queries: [],
            headers: [],
            body: {}
          },
          resDescriptor: {
            headers: [],
            body: {}
          }
        }
      }
    }
  },
  mounted: function() {    
    this.$data.sketch = this.$store.state.ApiSketch

    let postStr = JSON.stringify({ 
      appName: this.$store.state.AppDetails.name,
      apiId: this.sketch.apiId,
      path: this.sketch.path
      });
    fetch(InventoryAPI.apiMockCfg, {
        method: "POST",
        headers: cusHeaders,
        body: postStr
      })
      .then(res => {
        var contentType = res.headers.get("content-type")
        if (!res.ok) {
          return []
        } else if (!contentType || !contentType.includes("application/json")) {
          return []
        } else if (contentType && contentType.includes("application/json")) {
          return res.json()
        }
      })
      .then(retData => {
        if (retData.code !== 0) {
          return
        } else {
          if (retData.data) {
            console.log(retData.data)
            let config = retData.data
            if (!config.mockCfg.reqDescriptor.body) {
              config.mockCfg.reqDescriptor.body = defaultMockCfg.reqDescriptor.body
            }
            if (!config.mockCfg.resDescriptor.body) {
              config.mockCfg.resDescriptor.body = defaultMockCfg.resDescriptor.body
            }
            this.$data.config = config
            this.$store.commit({
              type: 'setApiConfig',
              ApiConfig: config
            })
          }
        }
      })
      .catch(ex => {
        console.log(ex);
      });
  },
  methods: {
    updateConfig: function() {
      let postStr = JSON.stringify(this.config)
      fetch(InventoryAPI.apiMockCfgUpdate, {
          method: "POST",
          headers: cusHeaders,
          body: postStr
        })
        .then(res => {
          let contentType = res.headers.get('content-type')
          if (!res.ok) {
            return null
          } else if (!contentType || !contentType.includes('application/json')) {
            return null
          } else {
            return res.json()
          }
        })
        .then(retData => {
          if (retData.code !== 0) {
            return
          } else {
            if (retData.data) {
              this.$data.config = retData.data
            }
          }
        })
        .catch(error => {
          console.log(error)
        })
    }
  },
  components: localComponents
};
</script>

<style>

#sp_method {
  background-color: blue;
  color: white;
  font-size: 32;
  margin-right: 20px;
}

#sp_path {
  background-color: rgb(185, 184, 184);
  font-size: 30 
}

#pn_details {
  margin: 80px 0 80px 0px;
  text-align: left;
  width: 100%;
}

#pn_details input {
  height: 28px;
  margin: 5px;
}

#pn_details label {
  display: inline-block;
  width: 170px;
}

#pn_details input[type="checkbox"] {
  width: 20px;
  height: 20px;
}

#pn_details .div-key {
  width: 80%;
  border: 1px dashed #000;
  margin: 5px 0 0 20px;
  padding: 5px;
}

#pn_details textarea {
  width: 800px;
  height: 300px;
}

#btn_submit {
  position: fixed;
  top: 640px;
  left: 1440px;
  width: 120px;
  height: 50px;
  background: blue;
  color: white;
}

</style>
